% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 
% % 使用小波变换对2幅图像进行融合，仅适用灰度图
% % % % % %参数说明：
%    M1     - 输入图像 A
%    M2     - 输入图像 B 
%    wtype  - 指定使用的小波基
%    Y      - 融合结果图像
% % 
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

clc;
clear;
close all;                
% % ===============================================
%   读入要进行融合的图像
% % ===============================================
imA = imread('pan.tif');
% 这里转化成double类型，否则使用小波变换输出的会有大量大于1的存在，会导致图像显示有问题
M1 = double(imA) / 256;   % 【问题1】
imB = imread('LR.tif');
imB = imresize(imB,4);
imB = rgb2gray(imB);
M2 = double(imB) / 256;


zt = 4;           % 设置小波分解的层数
wtype = 'haar';  % 设置小波基

% % ===============================================================
% 这里的融合规则是：在高频系数中，取2幅图像绝对值大的小波系数，
% 在低频系数中，取2幅图像的平均值。
% % ================================================================

% % ==============================================
% 对2幅图像分别进行小波分解
% % ==============================================
[c0,s0] = wavedec2(M1, zt, wtype);  
[c1,s1] = wavedec2(M2, zt, wtype); 


KK = size(c1);
Coef_Fusion = zeros(1,KK(2));  % 生成同系数矩阵c一样大的矩阵作为结果存储单元

Coef_Fusion(1:s1(1,1)*s1(1,2)) = (c0(1:s1(1,1)*s1(1,2))+c1(1:s1(1,1)*s1(1,2)))/2;


% % =============================================
% % 处理高频系数
% % =============================================
MM1 = c0(s1(1,1)*s1(1,2)+1:KK(2));
MM2 = c1(s1(1,1)*s1(1,2)+1:KK(2));
mm = (abs(MM1)) > (abs(MM2));
Y  = (mm.*MM1) + ((~mm).*MM2);
Coef_Fusion(s1(1,1)*s1(1,2)+1:KK(2)) = Y;


% % =============================================
% 重构
% % 这里我们已经生成新的系数矩阵了，并利用新的系数矩
% % 阵，进行小波逆变换
% % =============================================
Y = waverec2(Coef_Fusion,s0,wtype);

% % =============================================
% 显示图像
% % =============================================
subplot(2,2,1);imshow(M1);title('pan');
subplot(2,2,2);imshow(M2);title('LR');
subplot(223);imshow(Y,[]);title('融合图像');
